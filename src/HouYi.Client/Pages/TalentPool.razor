@page "/talent-pool"
@rendermode InteractiveAuto
@* @rendermode @(new InteractiveWebAssemblyRenderMode(prerender: false)) *@
@using HouYi.Models.Resumes
@using System.Reflection
@inject IResumeService ResumeService

<h3>人才库</h3>
<div class="table-responsive">
    <table class="table table-striped table-hover">
        <thead>
            <tr>
                <th>姓名</th>
                <th>性别</th>
                <th>年龄</th>
                <th>电话</th>
                <th>邮箱</th>
                <th>当前状态</th>
                <th>职位</th>
                <th>学历</th>
                <th>年薪(K)</th>
                <th>城市代码</th>
                <th>来源</th>
                <th>备注</th>
                <th>更新时间</th>
                <th>操作</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var resume in _resumes)
            {
                <tr>
                    <td><EditableCell T="string" Value="@resume.Name" Width="50px" OnValueChanged="@(v => UpdateProperty(resume.Id, nameof(Resume.Name), v))" /></td>
                    <td>
                        <EnumDropdown TEnum="Gender" Value="@resume.Gender" ValueChanged="@(v => UpdateProperty(resume.Id, nameof(Resume.Gender), new CellValue<Gender>(v, false)))" />
                    </td>
                    <td><EditableCell T="int" Value="@resume.Age" Width="50px" OnValueChanged="@(v => UpdateProperty(resume.Id, nameof(Resume.Age), v))" /></td>
                    <td><EditableCell T="string" Value="@resume.Phone" Width="120px" OnValueChanged="@(v => UpdateProperty(resume.Id, nameof(Resume.Phone), v))" /></td>
                    <td><EditableCell T="string" Value="@resume.Email" Width="160px" OnValueChanged="@(v => UpdateProperty(resume.Id, nameof(Resume.Email), v))" /></td>
                    <td>
                        <EnumDropdown TEnum="CurrentStatus" Value="@resume.CurrentStatus"
                        ValueChanged="@(v => UpdateProperty(resume.Id, nameof(Resume.CurrentStatus), new CellValue<CurrentStatus>(v, false)))" />
                    </td>
                    <td><EditableCell T="string" Value="@resume.Position" Width="150px" OnValueChanged="@(v => UpdateProperty(resume.Id, nameof(Resume.Position), v))" /></td>
                    <td>
                        <EnumDropdown TEnum="Degree" Value="@resume.Degree"
                        ValueChanged="@(v => UpdateProperty(resume.Id, nameof(Resume.Degree), new CellValue<Degree>(v, false)))" />
                    </td>
                    <td><EditableCell T="int" Value="@resume.AnnualSalary" Width="50px" OnValueChanged="@(v => UpdateProperty(resume.Id, nameof(Resume.AnnualSalary), v))" /></td>
                    <td><EditableCell T="short" Value="@resume.City" Width="80px" OnValueChanged="@(v => UpdateProperty(resume.Id, nameof(Resume.City), v))" /></td>
                    <td><EditableCell T="byte" Value="@resume.Source" Width="60px" OnValueChanged="@(v => UpdateProperty(resume.Id, nameof(Resume.Source), v))" /></td>
                    <td>
                        <EditableCell T="string" Value="@resume.Note" Width="240px" IsMultiline="true" OnValueChanged="@(v => UpdateProperty(resume.Id, nameof(Resume.Note), v))" /></td>
                    <td>
                        <div class="tooltip-container">
                            @resume.UpdatedAt.ToRelativeTimeString()
                            <span class="custom-tooltip">
                                更新于: @resume.UpdatedAt.ToString("yyyy-MM-dd HH:mm")<br />
                                创建于: @resume.CreatedAt.ToString("yyyy-MM-dd HH:mm")
                            </span>
                        </div>
                    </td>
                    <td>
                        <button class="btn btn-sm btn-primary" @onclick="() => OnCommunicate(resume)">沟通</button>
                        <button class="btn btn-sm btn-info" @onclick="() => OnViewHistory(resume)">沟通记录</button>
                        <button class="btn btn-sm btn-danger" @onclick="() => DeleteResume(resume.Id)">删除</button>
                    </td>
                </tr>
            }
        </tbody>
    </table>
</div>

<div class="d-flex justify-content-between align-items-center">
    <div>
        <select class="form-select" @bind="PageSize" @bind:event="onchange">
            <option value="10">10条/页</option>
            <option value="20">20条/页</option>
            <option value="50">50条/页</option>
        </select>
    </div>
    <nav>
        <ul class="pagination">
            <li class="page-item @(_currentPage == 0 ? "disabled" : "")">
                <button class="page-link" @onclick="async () => await NavigateToPage(0)" disabled="@(_currentPage == 0)">
                    首页
                </button>
            </li>
            <li class="page-item @(_currentPage == 0 ? "disabled" : "")">
                <button class="page-link" @onclick="async () => await NavigateToPage(_currentPage - 1)" disabled="@(_currentPage == 0)">
                    上一页
                </button>
            </li>

            @{
                const int maxVisiblePages = 5;
                int startPage = Math.Max(0, _currentPage - maxVisiblePages / 2);
                int endPage = Math.Min(TotalPages - 1, startPage + maxVisiblePages - 1);

                if (endPage - startPage + 1 < maxVisiblePages)
                {
                    startPage = Math.Max(0, endPage - maxVisiblePages + 1);
                }

                for (int i = startPage; i <= endPage; i++)
                {
                    var pageNumber = i;
                    <li class="page-item @(pageNumber == _currentPage ? "active" : "")">
                        <button class="page-link" @onclick="async () => await NavigateToPage(pageNumber)">
                            @(pageNumber + 1)
                        </button>
                    </li>
                }
            }

            <li class="page-item @(_currentPage >= TotalPages - 1 ? "disabled" : "")">
                <button class="page-link" @onclick="async () => await NavigateToPage(_currentPage + 1)" 
                disabled="@(_currentPage >= TotalPages - 1)">
                    下一页
                </button>
            </li>
            <li class="page-item @(_currentPage >= TotalPages - 1 ? "disabled" : "")">
                <button class="page-link" @onclick="async () => await NavigateToPage(TotalPages - 1)" 
                disabled="@(_currentPage >= TotalPages - 1)">
                    末页
                </button>
            </li>
        </ul>
    </nav>
</div>

@code {

    private List<Resume> _resumes = new();
    private int _totalCount;
    private int _currentPage;
    private int _pageSize = 10;
    private Type _modelType = typeof(Resume);

    private int PageSize
    {
        get => _pageSize;
        set
        {
            if (_pageSize != value)
            {
                _pageSize = value;
                InvokeAsync(async () =>
                {
                    await NavigateToPage(0);
                    StateHasChanged();
                });
            }
        }
    }

    private int TotalPages => (int)Math.Ceiling(_totalCount / (double)PageSize);

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    private async Task LoadData()
    {
        try
        {
            var result = await ResumeService.GetResumesAsync(_currentPage, PageSize);
            _resumes = new List<Resume>(result.Items);
            _totalCount = result.TotalCount;
            StateHasChanged();
        }
        catch
        {
            _resumes = new List<Resume>();
            _totalCount = 0;
            StateHasChanged();
        }
    }

    private async Task NavigateToPage(int page)
    {

        Console.WriteLine("Hit " + page);
        if (page < 0 || page >= TotalPages)
            return;

        _currentPage = page;
        await LoadData();
        StateHasChanged();
    }

    private async Task UpdateProperty<T>(string id, string propertyName, CellValue<T> cell)
    {
        var property = _modelType.GetProperty(propertyName)!;
        if (cell.ClientValidationEnabled)
        {
            Validate(property, cell);
        }
        if (!cell.IsValid)
            return;

        var result = await ResumeService.UpdateResumePropertyAsync(id, propertyName, cell.Value);
        if (result.IsValid)
        {
            var resume = _resumes.First(r => r.Id == id);
            var convertedValue = Convert.ChangeType(cell.Value, property.PropertyType);
            property.SetValue(resume, convertedValue);
            resume.UpdatedAt = DateTime.Now;
            cell.IsValid = true;
            StateHasChanged();
        }
        else
        {
            cell.IsValid = false;
            cell.ErrorMessage = result.ErrorMessage;
        }
    }

    private void Validate<T>(PropertyInfo property, CellValue<T> cell)
    {
        var result = ValidationHelper.ValidateProperty<Resume, T>(property, cell.Value);
        if (!result.IsValid)
        {
            cell.IsValid = false;
            cell.ErrorMessage = result.ErrorMessage;
        }
        else
        {
            cell.IsValid = true;
        }
    }

    private async Task DeleteResume(string id)
    {
        if (await ResumeService.DeleteResumeAsync(id))
        {
            _resumes.RemoveAll(r => r.Id == id);
            _totalCount--;
            if (_resumes.Count == 0 && _currentPage > 0)
            {
                await NavigateToPage(_currentPage - 1);
            }
            else
            {
                StateHasChanged();
            }
        }
    }

    private Task OnCommunicate(Resume resume)
    {
        // To be implemented
        return Task.FromResult(0);
    }

    private void OnViewHistory(Resume resume)
    {
        // To be implemented
    }
}
